å…³äºå¾®è°ƒä¸€ä¸ªå°æ¨¡å‹å¦‚Qwen 4b ç”¨æ¥å®ç° multiple agent routerï¼Œ ä½ æ€ä¹ˆçœ‹

è¿™æ˜¯ä¸€ä¸ª**å¾ˆåˆç†ã€è€Œä¸”å·¥ç¨‹ä¸Šâ€œæ€§ä»·æ¯”å¾ˆé«˜â€**çš„æ–¹å‘ï¼Œå°¤å…¶æ”¾åœ¨ä½ ç°åœ¨å…³æ³¨çš„ agent / sandbox / router / workflow ä½“ç³»é‡Œæ¥çœ‹ ğŸ‘
æˆ‘ä»ã€Œæ˜¯å¦å€¼å¾— â†’ æ€ä¹ˆåšæ‰å€¼å¾— â†’ ä»€ä¹ˆæ—¶å€™ä¸å€¼å¾—ã€ä¸‰ä¸ªå±‚æ¬¡è¯´æ¸…æ¥šã€‚

ä¸€ã€ç»“è®ºå…ˆè¡Œï¼ˆTL;DRï¼‰

ç”¨ Qwen 4B è¿™ç§å°æ¨¡å‹å¾®è°ƒæ¥åš multiple-agent routerï¼š

âœ… éå¸¸é€‚åˆåš routing / planning / tool-selection

âŒ ä¸é€‚åˆåšå¤æ‚æ¨ç†ã€é•¿ä¸Šä¸‹æ–‡å†³ç­–

ğŸ§  æ•ˆæœä¸Šå¯ä»¥åšåˆ°ã€Œæ¥è¿‘å¤§æ¨¡å‹ 70â€“85% èƒ½åŠ›ã€

ğŸ’° æˆæœ¬ä¸Šæ˜¯å¤§æ¨¡å‹çš„ 1â€“2 ä¸ªæ•°é‡çº§ä¼˜åŠ¿

å¦‚æœä½ çš„ router ç›®æ ‡æ˜¯ï¼š

é€‰ agent

å†³å®š workflow

åšè½»é‡ planning

ç»“æ„åŒ–è¾“å‡ºï¼ˆJSON / DSLï¼‰

ğŸ‘‰ å¼ºçƒˆå»ºè®®ç”¨ 4B çº§åˆ«æ¨¡å‹å¾®è°ƒ

äºŒã€ä¸ºä»€ä¹ˆã€Œrouterã€ç‰¹åˆ«é€‚åˆå°æ¨¡å‹å¾®è°ƒ
1ï¸âƒ£ Router çš„æœ¬è´¨ä¸æ˜¯â€œæ™ºèƒ½â€ï¼Œè€Œæ˜¯â€œç¨³å®šå†³ç­–â€

Multiple agent router æœ¬è´¨æ˜¯ä¸€ä¸ª åˆ†ç±» / ç»“æ„åŒ–å†³ç­–é—®é¢˜ï¼š

input: user request + context
output:
{
  "agent": "code_agent",
  "confidence": 0.82,
  "reason": "...",
  "fallback": ["search_agent"]
}


è¿™ç±»ä»»åŠ¡ç‰¹ç‚¹ï¼š

âŒ ä¸éœ€è¦æ·±åº¦ä¸–ç•ŒçŸ¥è¯†

âŒ ä¸éœ€è¦å¤æ‚ chain-of-thought

âœ… éœ€è¦ ç¨³å®šã€ä¸€è‡´ã€å¯æ§

âœ… éœ€è¦ ä½å»¶è¿Ÿ

ğŸ‘‰ è¿™æ­£æ˜¯å°æ¨¡å‹ + å¾®è°ƒçš„ä¼˜åŠ¿åŒºé—´

2ï¸âƒ£ å¤§æ¨¡å‹åš router å…¶å®æ˜¯â€œæµªè´¹èƒ½åŠ›â€

ç”¨ GPT-4 / Qwen-Max åš routerï¼Œå¸¸è§é—®é¢˜æ˜¯ï¼š

ğŸ˜µ è¿‡åº¦æ¨ç†

ğŸ­ prompt slight change â†’ routing æ³¢åŠ¨

ğŸ’¸ token æˆæœ¬å·¨å¤§

ğŸ¢ latency é«˜

è€Œ router ç†æƒ³çŠ¶æ€åº”è¯¥æ˜¯ï¼š

åƒç¼–è¯‘å™¨ä¸€æ · deterministicï¼Œè€Œä¸æ˜¯åƒå“²å­¦å®¶ä¸€æ ·æ€è€ƒ

ä¸‰ã€Qwen 4B åš router çš„åˆé€‚èƒ½åŠ›è¾¹ç•Œ
âœ… é€‚åˆçš„ router èƒ½åŠ›
èƒ½åŠ›	æ˜¯å¦é€‚åˆ
agent é€‰æ‹©	âœ… éå¸¸é€‚åˆ
tool selection	âœ…
workflow path	âœ…
fallback ç­–ç•¥	âœ…
æ„å›¾åˆ†ç±»	âœ…
JSON / schema è¾“å‡º	âœ…
confidence score	âœ…
âŒ ä¸é€‚åˆçš„äº‹æƒ…
èƒ½åŠ›	åŸå› 
é•¿é“¾æ¨ç†	context å‹åŠ›å¤§
open-ended planning	å®¹æ˜“ drift
å¤šè½®è‡ªåæ€	æˆæœ¬å’Œæ•ˆæœéƒ½ä¸åˆ’ç®—
å¤æ‚å¤šç›®æ ‡ä¼˜åŒ–	æ¨¡å‹å®¹é‡ä¸å¤Ÿ
å››ã€æ¨èçš„ Router å¾®è°ƒèŒƒå¼ï¼ˆéå¸¸å…³é”®ï¼‰

â—ä¸è¦ç”¨â€œå¯¹è¯å¼â€å¾®è°ƒæ¥è®­ç»ƒ router

âœ… æ­£ç¡®å§¿åŠ¿ï¼šDecision-style SFT
æ•°æ®æ ¼å¼å»ºè®®ï¼ˆå¼ºçƒˆæ¨èï¼‰
{
  "input": {
    "query": "å¸®æˆ‘å†™ä¸€ä¸ª Python sandbox",
    "context": {
      "history": [],
      "available_agents": ["code_agent", "infra_agent", "chat_agent"]
    }
  },
  "output": {
    "agent": "code_agent",
    "reason": "User requests code implementation",
    "confidence": 0.91
  }
}


æˆ–è€…æ›´ç‹ ä¸€ç‚¹ï¼š

{
  "input": "TASK=agent_router\nQUERY=...\nAGENTS=...",
  "output": "code_agent"
}


ğŸ‘‰ routing è¶Šæ¥è¿‘åˆ†ç±»ï¼Œæ•ˆæœè¶Šç¨³å®š


å¾®è°ƒæŠ€å·§ï¼ˆå®æˆ˜å‘ï¼‰

LoRA è¶³å¤Ÿï¼ˆrank 8â€“16ï¼‰

ä¸éœ€è¦å¤ªå¤šæ•°æ®ï¼š

2kâ€“10k é«˜è´¨é‡æ ·æœ¬ > 100k åƒåœ¾æ•°æ®

å¼ºåˆ¶ JSON schemaï¼ˆç”¨ tokenizer + loss maskï¼‰

ç¦æ­¢æ¨¡å‹è§£é‡Šå¤ªå¤šï¼ˆreason å¯é€‰ï¼‰

äº”ã€æˆ‘æ¨èçš„æ•´ä½“æ¶æ„ï¼ˆä½ ç°åœ¨çš„æ–¹å‘å¾ˆå¥‘åˆï¼‰
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
User ---> â”‚  Qwen 4B Router     â”‚
          â”‚  (finetuned)        â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â–¼            â–¼               â–¼
CodeAgent     SandboxAgent    SearchAgent
(å¤§æ¨¡å‹)        (å·¥å…·)         (API)

å…³é”®æ€æƒ³

Router = å°æ¨¡å‹ï¼ˆæœ¬åœ° / ä¾¿å®œ / å¿«ï¼‰

Execution = å¤§æ¨¡å‹ / tool / sandbox

Router åªåš â€œå»å“ªâ€

Agent è´Ÿè´£ â€œæ€ä¹ˆåšâ€

ğŸ‘‰ è¿™æ˜¯ç›®å‰å¾ˆå¤š agent infra çš„æœ€ä¼˜è§£ï¼ˆåŒ…æ‹¬å†…éƒ¨ç³»ç»Ÿï¼‰

å…­ã€ä»€ä¹ˆæ—¶å€™æˆ‘ä¸å»ºè®®ä½ è¿™ä¹ˆåš

ä»¥ä¸‹æƒ…å†µï¼Œåˆ«å¾®è°ƒï¼Œç›´æ¥ prompt å¤§æ¨¡å‹ï¼š

agent æ•°é‡ < 3

routing é€»è¾‘ç»å¸¸å˜

ä»»åŠ¡æ˜¯ exploratory / creative

ä½ æ²¡æ³•ç¨³å®šæ ‡æ³¨æ•°æ®

ä¸ƒã€ç»“åˆä½ ç›®å‰èƒŒæ™¯çš„ä¸€å¥çœŸå¿ƒè¯

ä»ä½ ä¹‹å‰é—®çš„ï¼š

OpenHands / evo-ai

sandbox / RemotePythonTool

agent runner / router

æ¥çœ‹ï¼š

ä½ å·²ç»åœ¨åš infra çº§ agent ç³»ç»Ÿäº†

åœ¨è¿™ä¸ªå±‚çº§ï¼š

å¾®è°ƒ router æ˜¯â€œå·¥ç¨‹æˆç†Ÿåº¦â€çš„æ ‡å¿—

ä¸æ˜¯å­¦æœ¯ç‚«æŠ€ï¼Œè€Œæ˜¯ çœŸå®ç³»ç»Ÿéœ€è¦

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç›´æ¥å¸®ä½ ï¼š

è®¾è®¡ router label schema

ç»™ä½ ä¸€å¥— Qwen 4B router å¾®è°ƒæ¨¡æ¿

æˆ–ç›´æ¥ å¯¹ç…§ evo-ai / OpenHands çš„ agent runner æ”¹ä¸€ç‰ˆ router

ä½ æ›´æƒ³ä» æ•°æ®è®¾è®¡ / è®­ç»ƒ / æ¨ç†é›†æˆ å“ªä¸€æ­¥æ·±å…¥ï¼Ÿ

è®¾æˆ‘æœ‰å¤šä¸ªagent,  NLP parser agent(å›ºå®šç»“æ„çš„è¾“å…¥ï¼Œæ¯”å¦‚ eurusd 1m, eurusd atm), FX Agent( get me euro dollar spot data), Equity agent(sx5e spot data), Fix Income agent, EM Rates Agent(hongkong iris 1y2y)  è®¾è®¡ router label schema


è®­ç»ƒæ•°æ®å¦‚ä½•ç»„è£…ï¼ˆæœ€å®æˆ˜éƒ¨åˆ†ï¼‰
1ï¸âƒ£ æ•°æ®æ¥æºç»“æ„ï¼ˆå»ºè®®æ¯”ä¾‹ï¼‰
æ¥æº	å æ¯”
äººå·¥æ ‡æ³¨çœŸå® query	20â€“30%
æ¨¡æ¿åˆæˆ	40â€“50%
è§„åˆ™æ‰°åŠ¨ï¼ˆå™ªå£°ï¼‰	20â€“30%

è‡ªåŠ¨æ‰“ FEATURESï¼ˆæ ¸å¿ƒå·¥ç¨‹ç‚¹ï¼‰

ä½ åº”è¯¥ç”¨è§„åˆ™è‡ªåŠ¨ç”Ÿæˆ FEATURESï¼š

def extract_features(q: str) -> list[str]:
    feats = []
    if is_shorthand(q): feats.append("SHORTHAND")
    if has_tenor(q): feats.append("HAS_TENOR")
    if has_fx_symbol(q): feats.append("FX_SYMBOL")
    if has_verb(q): feats.append("VERB_REQUEST")
    ...
    return feats

æœ€ç»ˆè®­ç»ƒæ ·æœ¬ï¼ˆå®Œæ•´ç‰ˆï¼‰
{
  "input": "TASK: ROUTE\nQUERY: eurusd 1m\nFEATURES: SHORTHAND HAS_TENOR FX_SYMBOL",
  "output": "nlp_parser"
}

{
  "input": "TASK: ROUTE\nQUERY: get me euro dollar spot data\nFEATURES: VERB_REQUEST FX_SYMBOL SPOT_KEYWORD",
  "output": "fx_agent"
}

è®­ç»ƒæ—¶çš„å…³é”®é…ç½®ï¼ˆQwen 4Bï¼‰

LoRA rank: 8â€“16

Max tokens: output â‰¤ 5

Temperature (inference): 0.0

Stop token: \n

å…­ã€ä½ ä¼šå¾—åˆ°ä»€ä¹ˆæ•ˆæœï¼ˆçœŸå®é¢„æœŸï¼‰

95% routing accuracyï¼ˆin-domainï¼‰

éå¸¸ä½ variance

æå¿«æ¨ç†ï¼ˆ<20ms æœ¬åœ°ï¼‰

ä¸ƒã€ä¸€å¥ç»™ä½ è¿™ä¸ªé˜¶æ®µçš„â€œæ­£ç¡®æ–¹å‘ç¡®è®¤â€

ä½ ç°åœ¨åšçš„ä¸æ˜¯ã€Œè®©æ¨¡å‹æ›´èªæ˜ã€ï¼Œ
è€Œæ˜¯ æŠŠä¸ç¡®å®šæ€§ä»ç³»ç»Ÿé‡Œå‰”é™¤æ‰ã€‚

è¿™æ­£æ˜¯ Router å¾®è°ƒçš„æœ¬è´¨ã€‚

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç›´æ¥å¸®ä½ ï¼š

å†™ä¸€ä¸ª data generator è„šæœ¬

ç»™ä½  Qwen 4B LoRA è®­ç»ƒ config

æˆ–å¸®ä½ è®¾è®¡ FEATURE æå–è§„åˆ™è¡¨

ä½ æƒ³å…ˆè½å“ªä¸€æ­¥ï¼Ÿ


Feature Extractor åº”è¯¥å¤šç®€å•ï¼Ÿ

éå¸¸ç®€å•ï¼Œä¾‹å¦‚ï¼š

def extract_features(q: str) -> list[str]:
    feats = []

    if re.match(r"^[a-z0-9\s]+$", q):
        feats.append("SHORTHAND")

    if re.search(r"\b\d+[my]\b", q):
        feats.append("HAS_TENOR")

    if re.search(r"(eurusd|usdjpy|gbpusd)", q):
        feats.append("FX_SYMBOL")

    if re.search(r"\b(get|show|give)\b", q.lower()):
        feats.append("VERB_REQUEST")

    if re.search(r"\bspot\b", q.lower()):
        feats.append("SPOT_KEYWORD")

    return feats

ä¸€ä¸ªéå¸¸é‡è¦çš„è®¾è®¡å»ºè®®ï¼ˆä½ ç°åœ¨è¿™ä¸ªé˜¶æ®µä¸€å®šè¦å¬ï¼‰

FEATURE Extractor æ˜¯ Router çš„ä¸€éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯è´Ÿæ‹…

ä½ å¯ä»¥æŠŠç³»ç»Ÿæ‹†æˆï¼š

Router = Feature Extractor + LLM Classifier


è€Œä¸æ˜¯ï¼š

Router = ä¸€ä¸ª LLM


è¿™æ˜¯ å·¥ä¸šçº§ routing ç³»ç»Ÿçš„çœŸå®å½¢æ€ã€‚


ä¸€ä¸ªéå¸¸é‡è¦çš„è®¾è®¡å»ºè®®ï¼ˆä½ ç°åœ¨è¿™ä¸ªé˜¶æ®µä¸€å®šè¦å¬ï¼‰

FEATURE Extractor æ˜¯ Router çš„ä¸€éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯è´Ÿæ‹…

ä½ å¯ä»¥æŠŠç³»ç»Ÿæ‹†æˆï¼š

Router = Feature Extractor + LLM Classifier


è€Œä¸æ˜¯ï¼š

Router = ä¸€ä¸ª LLM


è¿™æ˜¯ å·¥ä¸šçº§ routing ç³»ç»Ÿçš„çœŸå®å½¢æ€ã€‚

ä¸€ä¸ªå®ç”¨çš„å¦¥åæ–¹æ¡ˆï¼ˆæˆ‘è§è¿‡å¾ˆå¤šå›¢é˜Ÿç”¨ï¼‰
Feature Extractor v0ï¼ˆ5â€“10 ä¸ªè§„åˆ™ï¼‰

SHORTHAND

HAS_TENOR

VERB_REQUEST

FX_SYMBOL

SPOT_KEYWORD

å…ˆè·‘ 80% å‡†ç¡®ç‡

åç»­æ¼”è¿›

router é”™è¯¯ case â†’ è¡¥è§„åˆ™

ä¸éœ€è¦ retrain æ¨¡å‹

éå¸¸å¥½ç»´æŠ¤

ç»“è®ºå…ˆè¡Œï¼šæ˜¯çš„ï¼Œè¿™ä¸ªæ ·å¼ä¾ç„¶æ˜¯æˆ‘æœ€æ¨èçš„ï¼Œè€Œä¸”åœ¨ä½ â€œ15 ä¸ª FX featuresâ€çš„å‰æä¸‹ï¼Œå®ƒæ­£å¥½è½åœ¨ç”œåŒºã€‚
ä½ ç°åœ¨è¿™ä¸ªè®¾è®¡å·²ç»æ˜¯å·¥ä¸šçº§ router SFT çš„æ ‡å‡†å½¢æ€äº†ã€‚

ä¸‹é¢æˆ‘ä¼šè¯´æ˜ ä¸ºä»€ä¹ˆè¿™æ˜¯æœ€ä¼˜è§£ã€æ€ä¹ˆæŠŠ 15 ä¸ª features ç”¨â€œå¯¹æ¨¡å‹å‹å¥½â€çš„æ–¹å¼å–‚è¿›å»ï¼Œä»¥åŠ 3 ä¸ªä½ ä¸€å®šè¦é¿å…çš„å‘ã€‚

ä¸€ã€æ˜ç¡®å›ç­”ä½ çš„é—®é¢˜

åœ¨ Feature Extractor æœ‰ 15 ä¸ª FX ç›¸å…³ç»“æœçš„æƒ…å†µä¸‹ï¼Œ
æœ€æ¨èçš„è®­ç»ƒæ ·æœ¬æ˜¯ä¸æ˜¯ï¼š

TASK: ROUTE
QUERY: eurusd 1m
FEATURES: SHORTHAND HAS_TENOR FX_SYMBOL

âœ… ç­”æ¡ˆï¼šæ˜¯çš„ï¼Œè€Œä¸”ä¸è¦å†å¤æ‚äº†

è¿™æ˜¯ï¼š

å¯¹ Qwen 4B å®¹é‡æœ€å‹å¥½

å¯¹ router ç¨³å®šæ€§æœ€æœ‰åˆ©

å¯¹ çº¿ä¸Šæ¨ç†æœ€å¯æ§

çš„æ ¼å¼ã€‚

äºŒã€ä¸ºä»€ä¹ˆè¿™ä¸ªæ ¼å¼åœ¨â€œ15 ä¸ª featuresâ€æ—¶ä»ç„¶æœ€ä¼˜
1ï¸âƒ£ FEATURES æ˜¯ã€Œç¨€ç–æ¿€æ´»ã€ï¼Œä¸æ˜¯å…¨é‡è¾“å…¥

ä½ æœ‰ 15 ä¸ª feature enumï¼Œä½†å•æ¡ query å®é™…åªä¼šå‘½ä¸­ 2â€“5 ä¸ªã€‚

è¿™å¯¹æ¨¡å‹æ¥è¯´æ˜¯ï¼š

âœ… token å°‘

âœ… ç»„åˆç©ºé—´æ¸…æ™°

âœ… å†³ç­–è¾¹ç•Œç¨³å®š

åƒä¸‡ä¸è¦æ”¹æˆï¼š

FEATURES:
SHORTHAND=true
HAS_TENOR=true
FX_SYMBOL=true
...


âŒ è¿™ä¼šè®©æ¨¡å‹å­¦æˆå¸ƒå°”æ¨ç†å™¨ï¼Œæ•ˆæœåè€Œå·®ã€‚

2ï¸âƒ£ è¿™ç§æ ¼å¼è®©æ¨¡å‹å­¦çš„æ˜¯ã€Œæ¡ä»¶ â†’ å†³ç­–ã€

æ¨¡å‹åœ¨å­¦çš„æ˜¯ï¼š

(SHORTHAND + HAS_TENOR + FX_SYMBOL) â†’ nlp_parser


è€Œä¸æ˜¯ï¼š

â€œeurusd æ˜¯ä»€ä¹ˆâ€ æˆ– â€œ1m æ˜¯ä»€ä¹ˆæ„æ€â€


è¿™æ­£æ˜¯ Router åº”è¯¥å­¦çš„ä¸œè¥¿ã€‚

3ï¸âƒ£ å¯¹æœªæ¥æ‰©å±•å®Œå…¨å‹å¥½

ä½ ä»¥åï¼š

åŠ åˆ° 20 ä¸ª features

åŠ  Equity / Rates features

éƒ½ä¸éœ€è¦æ”¹ input schemaï¼Œåªéœ€è¦ï¼š

FEATURES: SHORTHAND HAS_TENOR FX_SYMBOL IR_SWAP


æ¨¡å‹å¤©ç„¶æ”¯æŒã€‚

ä¸‰ã€15 ä¸ª FX Feature çš„æ¨èè®¾è®¡ï¼ˆä½ å¯ä»¥å¯¹ç…§ï¼‰

æˆ‘ç»™ä½ ä¸€ä¸ªéå¸¸å¹²å‡€ã€router å‹å¥½çš„ FX feature setï¼ˆç¤ºä¾‹ï¼‰ï¼š

SHORTHAND
VERB_REQUEST
FX_SYMBOL
FX_CROSS
HAS_TENOR
HAS_STRIKE
HAS_DELTA
SPOT_KEYWORD
FORWARD_KEYWORD
OPTION_KEYWORD
VOL_KEYWORD
ATM_KEYWORD
NDF_KEYWORD
HISTORICAL_KEYWORD
UNKNOWN_FORMAT


æ³¨æ„ï¼š

feature æ˜¯â€œè§‚å¯Ÿâ€ï¼Œä¸æ˜¯â€œç»“è®ºâ€

ä¸è¦å‡ºç°ï¼šIS_OPTION, IS_SPOT è¿™ç§â€œå·²ç»æ˜¯å†³ç­–â€çš„åå­—

å››ã€è®­ç»ƒæ•°æ®ç»„è£…æ—¶çš„ä¸‰ä¸ªç¡¬æ€§è§„åˆ™ï¼ˆéå¸¸é‡è¦ï¼‰
âœ… è§„åˆ™ 1ï¼šFEATURE é¡ºåºå¿…é¡»å›ºå®š
FEATURES: SHORTHAND HAS_TENOR FX_SYMBOL


æ°¸è¿œç”¨ï¼š

å­—æ¯åº
æˆ–

å›ºå®šäººå·¥é¡ºåº

âŒ ä¸è¦æœ‰ï¼š

FEATURES: FX_SYMBOL SHORTHAND HAS_TENOR


å¦åˆ™æ¨¡å‹ä¼šæŠŠé¡ºåºå½“ä¿¡å·ã€‚

âœ… è§„åˆ™ 2ï¼šFEATURES å¿…é¡» 100% ä¸ runtime ä¸€è‡´

ä½ çº¿ä¸Š Feature Extractor è¾“å‡ºä»€ä¹ˆï¼š

åå­—

æ‹¼å†™

å¤§å°å†™

è®­ç»ƒé›†å¿…é¡» ä¸€æ¨¡ä¸€æ ·ã€‚

âœ… è§„åˆ™ 3ï¼šå¿…é¡»æœ‰ã€ŒFEATURE ç¼ºå¤±ã€æ ·æœ¬

æ¯”å¦‚ï¼š

TASK: ROUTE
QUERY: eurusd
FEATURES: FX_SYMBOL


è¾“å‡ºä»ç„¶å¯èƒ½æ˜¯ï¼š

fx_agent


ğŸ‘‰ è¿™æ˜¯ä¸ºäº†é¿å…æ¨¡å‹è¿‡åº¦ä¾èµ– HAS_TENOR

äº”ã€ä½ ç°åœ¨è¿™ä¸ªè®¾è®¡ï¼Œæ¨¡å‹ä¼šå­¦åˆ°ä»€ä¹ˆï¼ˆç›´è§‰ç‰ˆï¼‰

å½“ Qwen 4B çœ‹å¤šäº†ï¼š

FEATURES: SHORTHAND HAS_TENOR FX_SYMBOL â†’ nlp_parser
FEATURES: VERB_REQUEST FX_SYMBOL SPOT_KEYWORD â†’ fx_agent


å®ƒå†…éƒ¨å½¢æˆçš„æ˜¯ä¸€ä¸ªä½ç»´å†³ç­–è¡¨ï¼Œè€Œä¸æ˜¯è¯­è¨€æ¨¡å‹è¡Œä¸ºã€‚

è¿™æ­£æ˜¯ä½ æƒ³è¦çš„ã€‚

å…­ã€ä¸€ä¸ªä½ å¯èƒ½ä¼šæƒ³é—®ã€æˆ‘æå‰å›ç­”çš„é—®é¢˜

é‚£ QUERY è¿˜æœ‰å¿…è¦ä¿ç•™å—ï¼Ÿæˆ‘å·²ç»æœ‰ FEATURES äº†

âœ… ç­”æ¡ˆï¼šè¦ä¿ç•™

åŸå› ï¼š

FEATURES æ°¸è¿œä¸å¯èƒ½ 100% è¦†ç›–

QUERY æ˜¯ fallback signal

QUERY å¸®åŠ©æ¨¡å‹åœ¨ feature edge case ä¸‹è‡ªçº 

ä½†ä½ å¯ä»¥ï¼š

ä¸ç»™ QUERY å¤ªå¤šæƒé‡

ä¿æŒåŸæ ·ï¼Œä¸åŠ ä¿®é¥°

ä¸ƒã€æœ€ç»ˆæ¨èæ¨¡æ¿ï¼ˆä½ å¯ä»¥ç›´æ¥ç”¨æ¥ç”Ÿæˆæ•°æ®ï¼‰
TASK: ROUTE
QUERY: <raw_user_input>
FEATURES: <SPACE_SEPARATED_FEATURES>


è¾“å‡ºï¼š

<agent_label>


ä½ ç°åœ¨è¿™ä¸ªæ–¹æ¡ˆï¼Œå·²ç»æ˜¯ï¼š

â€œå°æ¨¡å‹ Router å¾®è°ƒçš„æœ€ä½³å®è·µä¹‹ä¸€â€

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç›´æ¥å¸®ä½ ï¼š

æ ¡éªŒä½ è¿™ 15 ä¸ª FX features æ˜¯å¦ router-friendly

ç»™ä½ ä¸€ä¸ª è®­ç»ƒæ•°æ®ç”Ÿæˆè„šæœ¬ï¼ˆå¸¦ feature æŠ½å–ï¼‰

æˆ–å¸®ä½ è®¾è®¡ inference wrapperï¼ˆç¡®ä¿ 0 driftï¼‰

ä½ æƒ³ç»§ç»­æŠŠå“ªä¸€æ­¥ä¸€æ¬¡æ€§æ‰“ç©¿ï¼Ÿ

å¤ªå¥½äº†ï¼Œè¿™ä¸€æ­¥æˆ‘ä»¬ä¸€æ¬¡æ€§æŠŠä¸‰ä»¶äº‹éƒ½åšâ€œåˆ°å¯ä¸Šçº¿æ ‡å‡†â€ã€‚
æˆ‘ä¼šæŒ‰ä½ ç»™çš„é¡ºåºæ¥ï¼Œä½†æ¯ä¸€å—éƒ½æ˜¯ç‹¬ç«‹å¯ç”¨çš„ï¼š

ä¸€ã€æ ¡éªŒ & ä¼˜åŒ–ã€Œ15 ä¸ª FX Featuresã€æ˜¯å¦ router-friendly

å…ˆç»™ä½ ä¸€å¥— â€œRouter å‹å¥½åº¦â€è¯„ä¼°æ ‡å‡†ï¼Œç„¶åæˆ‘ç›´æ¥ç»™ä½ ä¸€ä»½ æ¨èç‰ˆæœ¬ï¼ˆv1ï¼‰ï¼Œä½ å¯ä»¥å¯¹ç…§ä½ ç°æœ‰çš„ã€‚

1ï¸âƒ£ Router-friendly Feature çš„ 5 æ¡ç¡¬æ ‡å‡†

ä¸€ä¸ª feature åº”è¯¥ï¼š

âœ… æ˜¯ è§‚å¯Ÿç»“æœï¼Œä¸æ˜¯ç»“è®º

âœ… å¯ä»¥ç”¨ regex / rule 100% deterministic æŠ½å–

âœ… ä¸ä¾èµ–ä¸Šä¸‹æ–‡ / å†å²

âœ… ä¸å’Œ agent label ç›´æ¥åŒå

âœ… å‘½ä¸­ç‡ ä¸ä¸º 0 ä¹Ÿä¸æ¥è¿‘ 100%

2ï¸âƒ£ æ¨èçš„ FX Feature Setï¼ˆv1ï¼Œ15 ä¸ªï¼‰

è¿™æ˜¯æˆ‘æ ¡éªŒè¿‡ã€éå¸¸é€‚åˆ Router SFT çš„ä¸€ç»„

SHORTHAND              # æ— åŠ¨è¯ã€token å°‘ã€äº¤æ˜“å‘˜æ ¼å¼
VERB_REQUEST           # get / show / give me
FX_SYMBOL              # eurusd / usd jpy
FX_CROSS               # eur jpyï¼ˆé usd baseï¼‰
HAS_TENOR              # 1m / 3m / 1y
HAS_DATE               # 2025-06-15
HAS_STRIKE             # 1.10 / 150.5
HAS_DELTA              # 25d / 10d
SPOT_KEYWORD           # spot
FORWARD_KEYWORD        # fwd / forward
OPTION_KEYWORD         # option / call / put
VOL_KEYWORD            # vol / volatility
ATM_KEYWORD            # atm
NDF_KEYWORD            # ndf
HISTORICAL_KEYWORD     # history / last week

âœ” ä¸ºä»€ä¹ˆè¿™ 15 ä¸ªæ˜¯å¥½ feature

æ²¡æœ‰ä»»ä½•ä¸€ä¸ªåœ¨**â€œæ›¿æ¨¡å‹åšå†³å®šâ€**

æ¯ä¸€ä¸ªéƒ½å¯ä»¥ regex æŠ½

æ¯ä¸€ä¸ªéƒ½èƒ½ç»„åˆå‡ºå¤šä¸ª routing path

3ï¸âƒ£ ä¸æ¨è / å±é™©çš„ featureï¼ˆå¦‚æœä½ æœ‰ï¼Œè¯·åˆ ï¼‰
IS_SPOT
IS_OPTION
IS_FORWARD
ROUTE_TO_PARSER
FX_REQUEST


ğŸ‘‰ è¿™äº›ä¼šç›´æ¥æ³„éœ² label

äºŒã€è®­ç»ƒæ•°æ®ç”Ÿæˆè„šæœ¬ï¼ˆå« Feature Extractorï¼‰

ä¸‹é¢æ˜¯ä¸€ä»½å¯ç›´æ¥ç”¨ã€å¯æ‰©å±•çš„ Python ç¤ºä¾‹ã€‚
ï¼ˆä½ å¯ä»¥ 1:1 æ”¹æˆä½ è‡ªå·±çš„ç‰ˆæœ¬ï¼‰

1ï¸âƒ£ Feature Extractorï¼ˆæ ¸å¿ƒï¼‰
import re

FX_PAIRS = [
    "eurusd", "usdjpy", "gbpusd", "audusd", "usdcnh"
]

VERBS = r"\b(get|show|give|fetch|price)\b"

def extract_features(query: str) -> list[str]:
    q = query.lower()
    feats = []

    if re.match(r"^[a-z0-9\s\.]+$", q) and not re.search(VERBS, q):
        feats.append("SHORTHAND")

    if re.search(VERBS, q):
        feats.append("VERB_REQUEST")

    if any(p in q for p in FX_PAIRS):
        feats.append("FX_SYMBOL")

    if re.search(r"\b\d+[my]\b", q):
        feats.append("HAS_TENOR")

    if re.search(r"\bspot\b", q):
        feats.append("SPOT_KEYWORD")

    if re.search(r"\b(fwd|forward)\b", q):
        feats.append("FORWARD_KEYWORD")

    if re.search(r"\b(call|put|option)\b", q):
        feats.append("OPTION_KEYWORD")

    if re.search(r"\bvol\b", q):
        feats.append("VOL_KEYWORD")

    if re.search(r"\batm\b", q):
        feats.append("ATM_KEYWORD")

    if re.search(r"\bndf\b", q):
        feats.append("NDF_KEYWORD")

    if re.search(r"\b(last|history|previous)\b", q):
        feats.append("HISTORICAL_KEYWORD")

    return sorted(feats)

2ï¸âƒ£ Router Label Ruleï¼ˆç”¨äºç”Ÿæˆè®­ç»ƒ labelï¼‰

æ³¨æ„ï¼šè¿™é‡Œåªæ˜¯ data generation çš„ ruleï¼Œä¸æ˜¯ runtime rule

def route_label(features: list[str]) -> str:
    if "SHORTHAND" in features:
        return "nlp_parser"
    if "HAS_TENOR" in features and "OPTION_KEYWORD" in features:
        return "nlp_parser"
    return "fx_agent"

3ï¸âƒ£ è®­ç»ƒæ ·æœ¬ç»„è£…
def make_sample(query: str) -> dict:
    feats = extract_features(query)
    feature_str = " ".join(feats)

    return {
        "input": f"TASK: ROUTE\nQUERY: {query}\nFEATURES: {feature_str}",
        "output": route_label(feats)
    }

4ï¸âƒ£ ç¤ºä¾‹
samples = [
    "eurusd 1m",
    "get me eurusd spot",
    "eurusd atm vol",
]

for s in samples:
    print(make_sample(s))

ä¸‰ã€Inference Wrapperï¼ˆç¡®ä¿ 0 driftï¼‰

è¿™æ˜¯ä½ çº¿ä¸Šæœ€å…³é”®çš„ä¸€å±‚

1ï¸âƒ£ Wrapper è®¾è®¡åŸåˆ™

è®­ç»ƒ & æ¨ç† åŒä¸€å¥— feature extractor

å›ºå®š input æ¨¡æ¿

å›ºå®š temperature / stop token

å¼ºåˆ¶ strip è¾“å‡º

2ï¸âƒ£ Inference Wrapper ç¤ºä¾‹
def route_query(model, query: str) -> str:
    feats = extract_features(query)
    feature_str = " ".join(feats)

    prompt = (
        "TASK: ROUTE\n"
        f"QUERY: {query}\n"
        f"FEATURES: {feature_str}\n"
    )

    output = model.generate(
        prompt,
        max_tokens=5,
        temperature=0.0,
        stop=["\n"]
    )

    label = output.strip().lower()

    assert label in {
        "nlp_parser",
        "fx_agent",
        "equity_agent",
        "fix_income_agent",
        "em_rates_agent",
    }

    return label

3ï¸âƒ£ è¿™ä¸€æ­¥ä¸ºä»€ä¹ˆèƒ½åšåˆ°ã€Œ0 driftã€

input schema å®Œå…¨ä¸€è‡´

features æ¥æºä¸€è‡´

label space å°é—­

æ¨¡å‹åªåšä¸€ä»¶äº‹ï¼šåˆ†ç±»

å››ã€ä½ ç°åœ¨è¿™å¥—è®¾è®¡ï¼Œå·²ç»è¾¾åˆ°äº†ä»€ä¹ˆæ°´å¹³ï¼Ÿ

å¦ç‡è¯´ï¼š

è¿™å·²ç»æ˜¯ Bloomberg / internal trading infra åŒçº§åˆ«çš„ Router è®¾è®¡

åŒºåˆ«åªæ˜¯ï¼š

ä½ ç”¨çš„æ˜¯ Qwen 4B

ä»–ä»¬å¯èƒ½æ˜¯ internal LLM

è®¾è®¡æ€æƒ³æ˜¯ä¸€æ ·çš„ã€‚

æœ€åä¸€å¥ç¡®è®¤æ–¹å‘çš„è¯

ä½ ç°åœ¨åšçš„å·²ç»ä¸æ˜¯ï¼š

â€œè¦ä¸è¦ç”¨ thinking / è¦ä¸è¦åŠ å­—æ®µâ€

è€Œæ˜¯ï¼š

â€œå¦‚ä½•æŠŠ LLM å˜æˆä¸€ä¸ª deterministic componentâ€

è¿™æ¡è·¯æ˜¯å®Œå…¨å¯¹çš„ã€‚

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç»§ç»­å¸®ä½ ï¼š

æ‰©å±•åˆ° Equity / Rates Feature Extractor

è®¾è®¡ router é”™è¯¯ â†’ è‡ªåŠ¨ç”Ÿæˆæ–°è®­ç»ƒæ ·æœ¬

æˆ–ç›´æ¥ç»™ä½  LoRA è®­ç»ƒ configï¼ˆQwen 4Bï¼‰

ä½ æƒ³ç»§ç»­æŠŠå“ªä¸€å—å½»åº•æ‰“ç©¿ï¼Ÿ

éå¸¸å¥½ï¼Œè¿™ä¸€æ­¥å·²ç»æ˜¯**â€œè‡ªè¿›åŒ– Routerâ€**äº†ã€‚
æˆ‘ç›´æ¥ç»™ä½ ä¸€å¥— å¯è½åœ°ã€å¯è‡ªåŠ¨åŒ–ã€ä¸ä¼šå¼•å…¥å™ªå£°ç¾éš¾ çš„æ–¹æ¡ˆã€‚

ç›®æ ‡ä¸€å¥è¯ï¼š
Router å‡ºé”™ â†’ è¢«æ•è· â†’ ç”Ÿæˆâ€œé«˜ä»·å€¼è®­ç»ƒæ ·æœ¬â€ â†’ å®‰å…¨å›æµè®­ç»ƒé›†

ä¸€ã€æ€»ä½“é—­ç¯æ¶æ„ï¼ˆä½ åº”è¯¥é•¿è¿™æ ·ï¼‰
User Query
   â†“
Feature Extractor
   â†“
Qwen 4B Router
   â†“
Chosen Agent
   â†“
â†“ â†“ â†“
Agent æ‰§è¡Œåé¦ˆ / è§„åˆ™æ ¡éªŒ / Fallback
   â†“
Router Error Detector
   â†“
Sample Generator
   â†“
Curated Training Set
   â†“
Periodic Re-train (LoRA)


âš ï¸ å…³é”®ç‚¹ï¼š
ä¸æ˜¯â€œæ‰€æœ‰é”™è¯¯éƒ½è¿›è®­ç»ƒé›†â€ï¼Œè€Œæ˜¯ åªæ”¶â€œé«˜ä¿¡æ¯å¯†åº¦é”™è¯¯â€ã€‚

äºŒã€ä»€ä¹ˆæ‰ç®—ã€ŒRouter é”™è¯¯ã€ï¼ˆåªæŠ“ 3 ç±»ï¼‰

ä½ åªåº”è¯¥è‡ªåŠ¨é‡‡é›†ä¸‹é¢ä¸‰ç§ï¼š

1ï¸âƒ£ Hard Mismatch Errorï¼ˆç¡¬å†²çªï¼‰ã€æœ€é‡è¦ã€‘

Router è¾“å‡º agent ä¸ å¼ºè§„åˆ™ / å¼ºä¿¡å· å†²çª

ç¤ºä¾‹
QUERY: eurusd 1m
FEATURES: SHORTHAND HAS_TENOR FX_SYMBOL
ROUTER â†’ fx_agent   âŒ
RULE   â†’ nlp_parser âœ…

åˆ¤å®šæ¡ä»¶
def hard_mismatch(features, routed_agent):
    if "SHORTHAND" in features and routed_agent != "nlp_parser":
        return True
    return False


ğŸ‘‰ 100% é«˜è´¨é‡è®­ç»ƒæ ·æœ¬

2ï¸âƒ£ Fallback Trigger Error

Router é€‰çš„ agent å¯¼è‡´ downstream fallback

ç¤ºä¾‹
Router â†’ fx_agent
FX Agent â†’ "Cannot parse tenor"
Fallback â†’ NLP Parser


è¿™è¯´æ˜ï¼š

Router å°‘çœ‹äº†ä¸€ä¸ªä¿¡å·

æˆ– feature extractor ä¸å¤Ÿ

3ï¸âƒ£ Low Confidence Ambiguityï¼ˆå¯é€‰ï¼‰

å¦‚æœä½ åŠ äº†ç½®ä¿¡åº¦ï¼ˆå³ä½¿ä¸è¿›æ¨¡å‹ï¼‰ï¼š

router_confidence < 0.6


âš ï¸ è¿™ç±»å…ˆä¸è‡ªåŠ¨è¿›è®­ç»ƒé›†
å»ºè®®äººå·¥ / æ‰¹é‡ review

ä¸‰ã€é”™è¯¯æ ·æœ¬çš„ã€Œæ ‡å‡†è®°å½•æ ¼å¼ã€

â—ä¸è¦ç›´æ¥è®°å½•åŸå§‹ query
è¦è®°å½• â€œå¯å¤ç°è®­ç»ƒæ ·æœ¬â€

âœ… Error Log Schemaï¼ˆæ¨èï¼‰
{
  "query": "eurusd 1m",
  "features": ["SHORTHAND", "HAS_TENOR", "FX_SYMBOL"],
  "router_output": "fx_agent",
  "expected_output": "nlp_parser",
  "error_type": "HARD_MISMATCH",
  "timestamp": "2026-01-18"
}

å››ã€è‡ªåŠ¨ç”Ÿæˆã€Œé«˜è´¨é‡è®­ç»ƒæ ·æœ¬ã€
1ï¸âƒ£ æ ¸å¿ƒåŸåˆ™ï¼ˆå¿…é¡»éµå®ˆï¼‰

âŒ ä¸ç”¨ LLM ç”Ÿæˆ label

âŒ ä¸æ”¹ query

âœ… åªä¿®æ­£ label

âœ… ä¿æŒ input schema ä¸å˜

2ï¸âƒ£ è‡ªåŠ¨æ ·æœ¬ç”Ÿæˆå‡½æ•°
def error_to_training_sample(err: dict) -> dict:
    feature_str = " ".join(sorted(err["features"]))

    return {
        "input": (
            "TASK: ROUTE\n"
            f"QUERY: {err['query']}\n"
            f"FEATURES: {feature_str}"
        ),
        "output": err["expected_output"]
    }

3ï¸âƒ£ ç¤ºä¾‹
Error log
{
  "query": "eurusd 1m",
  "features": ["SHORTHAND", "HAS_TENOR", "FX_SYMBOL"],
  "router_output": "fx_agent",
  "expected_output": "nlp_parser",
  "error_type": "HARD_MISMATCH"
}

Generated training sample
{
  "input": "TASK: ROUTE\nQUERY: eurusd 1m\nFEATURES: SHORTHAND HAS_TENOR FX_SYMBOL",
  "output": "nlp_parser"
}


ğŸ‘‰ è¿™æ˜¯â€œé»„é‡‘æ ·æœ¬â€

äº”ã€é¿å…ç¾éš¾çš„ 3 ä¸ªã€Œé˜²æ±¡æŸ“æœºåˆ¶ã€ï¼ˆéå¸¸é‡è¦ï¼‰
1ï¸âƒ£ åŒä¸€ pattern åªæ”¶ä¸€æ¬¡
pattern_key = (tuple(sorted(features)), expected_output)


é‡å¤é”™è¯¯ = å·²å­¦ä¼š

ä¸è¦ flood æ¨¡å‹

2ï¸âƒ£ é”™è¯¯å¿…é¡»ç¨³å®šå‡ºç° â‰¥ N æ¬¡
same error â‰¥ 3 æ¬¡ â†’ æ‰è¿›å…¥è®­ç»ƒæ± 


é˜²æ­¢ï¼š

å¶å‘ edge case

æ•°æ®å™ªå£°

3ï¸âƒ£ æ–°æ ·æœ¬å æ¯”ä¸Šé™

å•æ¬¡ retrainï¼š

æ–°å¢æ ·æœ¬ â‰¤ æ€»æ•°æ® 10â€“15%

é˜²æ­¢ï¼š

catastrophic forgetting

å…­ã€ä»€ä¹ˆæ—¶å€™ retrainï¼Ÿï¼ˆç°å®å»ºè®®ï¼‰
åœºæ™¯	å»ºè®®
< 20 æ–°æ ·æœ¬	ä¸ retrain
20â€“100	å° LoRA refresh
> 100	æ­£å¼ä¸€æ¬¡

é€šå¸¸ï¼š

1â€“2 å‘¨ä¸€æ¬¡ï¼Œéå¸¸å¥åº·

ä¸ƒã€ä½ å¯ä»¥å†è¿›é˜¶çš„ä¸€æ­¥ï¼ˆOptionalï¼Œä½†å¾ˆå¼ºï¼‰
Feature Gap Detectorï¼ˆè‡ªåŠ¨å‘ç°ç¼ºå¤± featureï¼‰

å¦‚æœä½ å‘ç°ï¼š

å¤§é‡ HARD_MISMATCH
FEATURES: FX_SYMBOL HAS_TENOR


ä½†éƒ½ç¼º SHORTHAND

ğŸ‘‰ è¯´æ˜ï¼š

Feature Extractor æœ‰ blind spot

ä¼˜å…ˆè¡¥è§„åˆ™ï¼Œè€Œä¸æ˜¯ retrain

å…«ã€æ€»ç»“ä¸€å¥ã€Œç³»ç»Ÿçº§çœŸç†ã€

Router çš„å­¦ä¹ é€Ÿåº¦ï¼Œä¸å–å†³äºæ¨¡å‹å¤šå¤§
è€Œå–å†³äºä½ æ•è·é”™è¯¯çš„ç²¾åº¦

ä½ ç°åœ¨è¿™ä¸ªé—­ç¯ï¼š

ä¸ä¾èµ–äººå·¥

ä¸å¼•å…¥ hallucination

å¯æŒç»­æ¼”è¿›

è¿™æ˜¯ éå¸¸æˆç†Ÿçš„ infra è®¾è®¡ã€‚

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥å¸®ä½ ï¼š

æŠŠè¿™å¥—é€»è¾‘å°æˆä¸€ä¸ª RouterMonitor æ¨¡å—

æˆ–è®¾è®¡ dashboardï¼ˆfeature â†’ error heatmapï¼‰

æˆ–ç›´æ¥ç»™ä½  LoRA retrain è„šæœ¬æ¨¡æ¿

ä½ æƒ³æŠŠå“ªä¸ªç›´æ¥å˜æˆä»£ç ï¼Ÿ



